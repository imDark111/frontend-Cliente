<div class="perfil-container">
  <div class="perfil-card">
    <div class="perfil-header">
      <h1>Mi Perfil</h1>
      @if (cliente) {
        <p class="user-info">
          <span class="badge-role">{{ cliente.rol }}</span>
          @if (dobleAutenticacion) {
            <span class="badge-2fa">üîê 2FA Activo</span>
          }
        </p>
      }
    </div>

    <!-- Mensaje de Error -->
    @if (error) {
      <div class="alert alert-error">
        ‚ö†Ô∏è {{ error }}
      </div>
    }

    <!-- Mensaje de √âxito -->
    @if (exito) {
      <div class="alert alert-success">
        ‚úÖ {{ exito }}
      </div>
    }

    <!-- Informaci√≥n del Perfil -->
    @if (cliente && !mostrar2FA) {
      <div class="perfil-section">
      <div class="section-header">
        <h2>üìã Informaci√≥n Personal</h2>
        <button 
          type="button" 
          class="btn-icon" 
          (click)="toggleEditar()"
          [disabled]="cargando"
        >
          {{ editando ? '‚ùå Cancelar' : '‚úèÔ∏è Editar' }}
        </button>
      </div>

      <form class="perfil-form">
        <div class="form-row">
          <div class="form-group">
            <label>Usuario</label>
            <input 
              type="text" 
              [value]="cliente.nombreUsuario" 
              disabled
              class="disabled-input"
            />
          </div>

          <div class="form-group">
            <label>Email</label>
            <input 
              type="email" 
              [value]="cliente.email" 
              disabled
              class="disabled-input"
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Nombres</label>
            <input 
              type="text" 
              [(ngModel)]="nombres" 
              name="nombres"
              [disabled]="!editando"
              [class.disabled-input]="!editando"
            />
          </div>

          <div class="form-group">
            <label>Apellidos</label>
            <input 
              type="text" 
              [(ngModel)]="apellidos" 
              name="apellidos"
              [disabled]="!editando"
              [class.disabled-input]="!editando"
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>C√©dula</label>
            <input 
              type="text" 
              [value]="cliente.cedula" 
              disabled
              class="disabled-input"
            />
          </div>

          <div class="form-group">
            <label>Fecha de Nacimiento</label>
            <input 
              type="date" 
              [(ngModel)]="fechaNacimiento" 
              name="fechaNacimiento"
              [disabled]="!editando"
              [class.disabled-input]="!editando"
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Tel√©fono</label>
            <input 
              type="tel" 
              [(ngModel)]="telefono" 
              name="telefono"
              [disabled]="!editando"
              [class.disabled-input]="!editando"
            />
          </div>

          <div class="form-group">
            <label>Direcci√≥n</label>
            <input 
              type="text" 
              [(ngModel)]="direccion" 
              name="direccion"
              [disabled]="!editando"
              [class.disabled-input]="!editando"
            />
          </div>
        </div>

        @if (editando) {
          <div class="form-actions">
            <button 
              type="button" 
              class="btn-secondary" 
              (click)="toggleEditar()"
              [disabled]="cargando"
            >
              Cancelar
            </button>
            <button 
              type="button" 
              class="btn-primary" 
              (click)="guardarCambios()"
              [disabled]="cargando"
            >
              @if (!cargando) {
                <span>üíæ Guardar Cambios</span>
              }
              @if (cargando) {
                <span>Guardando...</span>
              }
            </button>
          </div>
        }
      </form>
      </div>
    }

    <!-- Cambiar Contrase√±a -->
    @if (!mostrar2FA) {
      <div class="perfil-section">
      <div class="section-header">
        <h2>üîí Seguridad</h2>
        <button 
          type="button" 
          class="btn-icon" 
          (click)="cambiarPassword = !cambiarPassword"
          [disabled]="cargando"
        >
          {{ cambiarPassword ? '‚ùå Cancelar' : 'üîë Cambiar Contrase√±a' }}
        </button>
      </div>

      @if (cambiarPassword) {
        <form class="perfil-form">
        <div class="form-group">
          <label>Contrase√±a Actual</label>
          <input 
            type="password" 
            [(ngModel)]="passwordActual" 
            name="passwordActual"
            placeholder="Ingresa tu contrase√±a actual"
          />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Nueva Contrase√±a</label>
            <input 
              type="password" 
              [(ngModel)]="passwordNuevo" 
              name="passwordNuevo"
              placeholder="M√≠nimo 6 caracteres"
            />
          </div>

          <div class="form-group">
            <label>Confirmar Contrase√±a</label>
            <input 
              type="password" 
              [(ngModel)]="confirmarPassword" 
              name="confirmarPassword"
              placeholder="Repite la contrase√±a"
            />
          </div>
        </div>

        <div class="form-actions">
          <button 
            type="button" 
            class="btn-secondary" 
            (click)="cambiarPassword = false"
            [disabled]="cargando"
          >
            Cancelar
          </button>
          <button 
            type="button" 
            class="btn-primary" 
            (click)="actualizarPassword()"
            [disabled]="cargando"
          >
            @if (!cargando) {
              <span>üîê Actualizar Contrase√±a</span>
            }
            @if (cargando) {
              <span>Actualizando...</span>
            }
          </button>
        </div>
        </form>
      }
      </div>
    }

    <!-- Autenticaci√≥n en Dos Pasos -->
    @if (!mostrar2FA) {
      <div class="perfil-section">
      <div class="section-header">
        <h2>üîê Autenticaci√≥n en Dos Pasos (2FA)</h2>
        <div class="twofa-status">
          <span 
            class="status-badge" 
            [class.active]="dobleAutenticacion"
            [class.inactive]="!dobleAutenticacion"
          >
            {{ dobleAutenticacion ? 'Activo' : 'Inactivo' }}
          </span>
        </div>
      </div>

      <p class="section-description">
        La autenticaci√≥n en dos pasos a√±ade una capa extra de seguridad a tu cuenta.
        Necesitar√°s un c√≥digo de tu aplicaci√≥n de autenticaci√≥n cada vez que inicies sesi√≥n.
      </p>

      <div class="twofa-actions">
        @if (!dobleAutenticacion) {
          <button 
            type="button" 
            class="btn-primary" 
            (click)="habilitar2FA()"
            [disabled]="cargando"
          >
            üîê Habilitar 2FA
          </button>
        }

        @if (dobleAutenticacion) {
          <button 
            type="button" 
            class="btn-danger" 
            (click)="deshabilitar2FA()"
            [disabled]="cargando"
          >
            üîì Deshabilitar 2FA
          </button>
        }
      </div>
      </div>
    }

    <!-- Configuraci√≥n 2FA -->
    @if (mostrar2FA) {
      <div class="twofa-setup">
      <h2>Configurar Autenticaci√≥n en Dos Pasos</h2>
      
      <div class="setup-steps">
        <div class="step">
          <div class="step-number">1</div>
          <div class="step-content">
            <h3>Descarga una aplicaci√≥n de autenticaci√≥n</h3>
            <p>Recomendamos Google Authenticator, Microsoft Authenticator o Authy</p>
          </div>
        </div>

        <div class="step">
          <div class="step-number">2</div>
          <div class="step-content">
            <h3>Escanea el c√≥digo QR</h3>
            <div class="qr-container">
              <img [src]="qrCode" alt="QR Code" class="qr-code" />
            </div>
            <p class="secret-key">
              <strong>Clave secreta:</strong> {{ secreto2FA }}
            </p>
          </div>
        </div>

        <div class="step">
          <div class="step-number">3</div>
          <div class="step-content">
            <h3>Ingresa el c√≥digo de verificaci√≥n</h3>
            <div class="form-group">
              <input 
                type="text" 
                [(ngModel)]="codigo2FA" 
                name="codigo2FA"
                placeholder="000000"
                maxlength="6"
                class="code-input"
              />
            </div>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button 
          type="button" 
          class="btn-secondary" 
          (click)="cancelar2FA()"
          [disabled]="cargando"
        >
          Cancelar
        </button>
        <button 
          type="button" 
          class="btn-primary" 
          (click)="verificar2FA()"
          [disabled]="cargando || codigo2FA.length !== 6"
        >
          @if (!cargando) {
            <span>‚úÖ Verificar y Activar</span>
          }
          @if (cargando) {
            <span>Verificando...</span>
          }
        </button>
      </div>
      </div>
    }

    <!-- Bot√≥n Cerrar Sesi√≥n -->
    @if (!mostrar2FA) {
      <div class="logout-section">
        <button type="button" class="btn-logout" (click)="cerrarSesion()">
          üö™ Cerrar Sesi√≥n
        </button>
      </div>
    }
  </div>
</div>
